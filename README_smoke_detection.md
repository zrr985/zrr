# 吸烟检测功能修改说明

## 概述

根据您的需求，我已经修改了吸烟检测模型，现在支持三个类别：`['cigarette', 'face', 'smoking']`，并添加了智能判断逻辑来减少误报。

## 主要修改内容

### 1. 吸烟检测更新 (`func_smoke.py`)

- **原类别**: `('smoking')`
- **新类别**: `('cigarette', 'face', 'smoking')`

### 2. 吸烟检测增强逻辑

新的检测逻辑包含两个条件：

1. **直接检测**: 检测到 `smoking` 类别
2. **组合检测**: 同时检测到 `face` 和 `cigarette`，且持续一定时间（减少误报）

### 3. 安全帽检测完善

- **添加全局变量**: `class_hardhat`
- **单独UDP处理**: 安全帽检测数据独立处理
- **数据推送**: 检测到未戴安全帽时自动推送数据

### 4. 视觉反馈优化

- **颜色编码**:
  - `cigarette` (香烟): 黄色 `(0, 255, 255)`
  - `face` (人脸): 绿色 `(0, 255, 0)`
  - `smoking` (吸烟): 红色 `(0, 0, 255)`

- **状态显示**: 在图像上显示实时检测状态

### 5. 数据推送机制

- **吸烟检测**: 检测到吸烟行为时自动推送数据到服务器
- **安全帽检测**: 检测到未戴安全帽时自动推送数据到服务器
- **连续检测**: 连续检测10帧后触发推送，避免误报
- **UDP通信**: 支持UDP数据通信

## 文件修改清单

### 核心文件
1. **`func_smoke.py`** - 主要检测逻辑
2. **`rknnpool_smoke_single.py`** - RKNN模型池管理
3. **`maincopy.py`** - 主程序集成

### 新增文件
1. **`test_smoke_detection.py`** - 测试脚本
2. **`README_smoke_detection.md`** - 说明文档

## 使用方法

### 1. 运行主程序
```bash
python maincopy.py
```

### 2. 启动吸烟检测任务
通过UDP命令启动任务代号 `5` (吸烟检测)

### 3. 测试功能
```bash
python test_smoke_detection.py
```

## 检测逻辑详解

### 智能判断算法

```python
# 条件1：直接检测到smoking类别
# 条件2：同时检测到face和cigarette，且持续一定时间
smoking_detected = has_smoking or (face_cigarette_ratio >= 0.6 and len(self.face_cigarette_history) >= 5)
```

### 参数说明

- **检测阈值**: `detection_threshold = 0.7` (70%的帧检测到才认为在吸烟)
- **窗口大小**: `window_size = 10` (滑动窗口大小)
- **组合检测比例**: `face_cigarette_ratio >= 0.6` (60%的帧同时检测到face和cigarette)
- **最小历史长度**: `len(self.face_cigarette_history) >= 5` (至少5帧的历史记录)

## 数据推送格式

### 吸烟检测UDP数据包格式
```
(1, 1, 0, 5, state, 1, 0, 0, 0)
```

- **第4位**: 5 (吸烟检测)
- **第5位**: 吸烟状态 (1: 检测到吸烟, 0: 未检测到)
- **第6位**: 数据类型 (1: 吸烟检测)

### 安全帽检测UDP数据包格式
```
(1, 1, 0, 2, state, 1, 0, 0, 0)
```

- **第4位**: 2 (安全帽检测)
- **第5位**: 安全帽状态 (1: 未戴安全帽, 0: 戴安全帽)
- **第6位**: 数据类型 (1: 安全帽检测)

### 推送条件
- 连续检测到异常行为10帧
- 避免重复推送（`abnormal_pushed` 标志）

## 注意事项

1. **模型文件**: 确保 `smoking.rknn` 模型文件存在且支持三个类别
2. **摄像头**: 需要可用的RGB摄像头
3. **网络**: 确保UDP通信正常
4. **性能**: 建议在RKNN设备上运行以获得最佳性能

## 故障排除

### 常见问题

1. **模型加载失败**
   - 检查 `smoking.rknn` 文件是否存在
   - 确认模型支持三个类别

2. **检测不准确**
   - 调整 `detection_threshold` 参数
   - 检查摄像头质量和环境光线

3. **数据推送失败**
   - 检查网络连接
   - 确认服务器地址和端口正确

## 后续优化建议

1. **模型优化**: 根据实际使用情况调整模型参数
2. **阈值调优**: 根据环境调整检测阈值
3. **日志记录**: 添加详细的日志记录功能
4. **性能监控**: 添加性能监控和统计功能 